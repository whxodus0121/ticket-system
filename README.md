# ðŸŽ« í‹°ì¼“ ì˜ˆë§¤ ë™ì‹œì„± ì œì–´ í”„ë¡œì íŠ¸ (Ticket-System)

ì´ í”„ë¡œì íŠ¸ëŠ” ë™ì‹œì„± ìš”ì²­ì´ ë°œìƒí•˜ëŠ” í‹°ì¼“ ì˜ˆë§¤ ìƒí™©ì—ì„œ ë°ì´í„°ì˜ ì •í•©ì„±ì„ ë³´ìž¥í•˜ê³ , 
ì‹œìŠ¤í…œ ë¶€í•˜ë¥¼ ìµœì†Œí™”í•˜ëŠ” ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ í•´ê²°í•´ ë‚˜ê°€ëŠ” ë°±ì—”ë“œ ì‹œìŠ¤í…œìž…ë‹ˆë‹¤.

## ðŸ“Œ ë²„ì „ë³„ ê°œë°œ ê¸°ë¡ (Tags)

### ðŸ”´ v1.0: ì¸í”„ë¼ êµ¬ì¶• ë° ê¸°ë³¸ ì—°ë™
- **ì£¼ìš” ë‚´ìš©**: Redis ë¶„ì‚° ë½ ë° MySQL ì—°ë™ ì™„ë£Œ
- **í•™ìŠµ í¬ì¸íŠ¸**: Dockerë¥¼ ì´ìš©í•œ Redis, MySQL í™˜ê²½ êµ¬ì¶• ë° Go ì–¸ì–´ì™€ì˜ ê¸°ë³¸ì ì¸ ì»¤ë„¥ì…˜ ì„¤ì •

### ðŸŸ¡ v2.0: ë™ì‹œì„± ì´ìŠˆ í•´ê²° (ì´ˆê³¼ íŒë§¤ ë°©ì§€)
- **ì£¼ìš” ë‚´ìš©**: ì´ˆê³¼ íŒë§¤ ë°©ì§€, DB ì—°ê²° í­ì£¼ ì—ëŸ¬ í•´ê²°, ì˜ˆë§¤ ì„±ê³µ ëª…ë‹¨ ê´€ë¦¬
- **í•´ê²° ë°©ë²•**: 
  - Redis ë¶„ì‚° ë½ì„ í†µí•œ ìž¬ê³  ì°¨ê°ì˜ ì›ìžì„± ë³´ìž¥
  - DB ì»¤ë„¥ì…˜ í’€ ìµœì í™”ë¡œ `Too many connections` ì—ëŸ¬ í•´ê²°
- **ê²°ê³¼**: ë™ì‹œì— 1,000ëª…ì´ ì ‘ì†í•´ë„ ì„¤ì •ëœ ìž¬ê³ ë§Œí¼ë§Œ ì •í™•ížˆ íŒë§¤ë¨ì„ í™•ì¸

### ðŸŸ¢ v3.0: ë¹„ì¦ˆë‹ˆìŠ¤ ì •ì±… ì ìš© (1ì¸ 1ë§¤ ì œí•œ)
- **ì£¼ìš” ë‚´ìš©**: 1ì¸ 1ë§¤ ì¤‘ë³µ ë°©ì§€ ë¡œì§ ì¶”ê°€
- **í•´ê²° ë°©ë²•**: 
  - **Double-Checked Locking**: ë½ íšë“ ì „í›„ë¡œ êµ¬ë§¤ ì´ë ¥ì„ í™•ì¸í•˜ì—¬ ì¤‘ë³µ ì˜ˆë§¤ë¥¼ ì›ì²œ ì°¨ë‹¨
  - ê³ ë¶€í•˜ ìƒí™©ì—ì„œ ë°œìƒí•˜ëŠ” **Slow SQL** ë¡œê·¸ ë¶„ì„ì„ í†µí•´ ì„±ëŠ¥ ë³‘ëª© ì§€ì  íŒŒì•…
- **ê²°ê³¼**: ë™ì¼ ì•„ì´ë””ë¡œ ë¬´í•œ ìš”ì²­ì„ ë³´ë‚´ë„ ì˜¤ì§ 1ê±´ì˜ êµ¬ë§¤ ë°ì´í„°ë§Œ ë‚¨ë„ë¡ ë³´ìž¥

### ðŸ”µ v4.0: í‹°ì¼“ ì·¨ì†Œ ë¡œì§ êµ¬í˜„ ë° ì‹œìŠ¤í…œ ì„±ëŠ¥ í•œê³„ ë„ì¶œ
- **ì£¼ìš” ë‚´ìš©**: ì˜ˆë§¤ ì·¨ì†Œ ê¸°ëŠ¥ êµ¬í˜„ ë° Redis-DB ê°„ ë°ì´í„° ì •í•©ì„± ë³´ìž¥
- **í•´ê²° ë°©ë²•**: 
  - ì·¨ì†Œ í”„ë¡œì„¸ìŠ¤ ì„¤ê³„: MySQL êµ¬ë§¤ ë‚´ì—­ ì‚­ì œ â†’ Redis ìž¬ê³  ë³µêµ¬(+1) â†’ Redis êµ¬ë§¤ìž ëª…ë‹¨ ì œê±°ì˜ ìˆœì°¨ì  íë¦„ êµ¬í˜„
  - ë°ì´í„° ì •í•©ì„± ê²€ì¦: DBì— ì‹¤ì œ êµ¬ë§¤ ë‚´ì—­ì´ ìžˆëŠ” ê²½ìš°ì—ë§Œ ì·¨ì†Œë¥¼ ìŠ¹ì¸í•˜ì—¬, ë¹„ì •ìƒì ì¸ ìž¬ê³  ì¦ê°€(Over-stocking)ë¥¼ ì›ì²œ ì°¨ë‹¨
  - âš ï¸ ì§ë©´í•œ ë¬¸ì œ (Slow SQL ìž¬ë°œ)
  - í˜„ìƒ: ë™ì‹œ ì˜ˆë§¤ í…ŒìŠ¤íŠ¸ ì‹œ MySQL INSERT ê³¼ì •ì—ì„œ 0.5s ì´ìƒì˜ ì§€ì—°ì´ ë°œìƒí•˜ëŠ” Slow SQL ìž¬ë°œ í™•ì¸
  - ì›ì¸ ë¶„ì„: Redisì˜ ì¸ë©”ëª¨ë¦¬ ì²˜ë¦¬ ì†ë„ì™€ MySQLì˜ ë””ìŠ¤í¬ I/O ì²˜ë¦¬ ì†ë„ ì°¨ì´ë¡œ ì¸í•œ ë™ê¸°ì‹ ì €ìž¥ì˜ ë³‘ëª© í˜„ìƒ ë°œìƒ
- **ê²°ê³¼**: ì˜ˆë§¤ì™€ ì·¨ì†Œì˜ ì „ì²´ ì‚¬ì´í´ì€ ì™„ì„±ë˜ì—ˆìœ¼ë‚˜, ê³ ë¶€í•˜ í™˜ê²½ì—ì„œì˜ ì•ˆì •ì ì¸ ì“°ê¸° ì„±ëŠ¥ì„ ìœ„í•´ ë¹„ë™ê¸° ë©”ì‹œì§€ í(Kafka) ë„ìž…ì˜ í•„ìš”ì„±ì„ ê¸°ìˆ ì ìœ¼ë¡œ ë„ì¶œ

### ðŸŸ£ v4.5: Kafka ë¹„ë™ê¸° ì²˜ë¦¬ ì™„ì„± ë° ë¶„ì‚° í™˜ê²½ ë©±ë“±ì„± ë³´ìž¥
- **ì£¼ìš” ë‚´ìš©**: Kafka ë„ìž…ì„ í†µí•œ ì“°ê¸° ì§€ì—°(Write-Behind) íŒ¨í„´ êµ¬í˜„ ë° ë©”ì‹œì§€ ì¤‘ë³µ ì²˜ë¦¬ ìµœì í™”
- **í•´ê²° ë°©ë²•**: 
  - ë¹„ë™ê¸° ì €ìž¥ íŒŒì´í”„ë¼ì¸: API ì„œë²„ëŠ” Kafka Producerë¡œì„œ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ê³  ì¦‰ì‹œ ì‘ë‹µí•˜ë©°, ë³„ë„ì˜ Consumer ì›Œì»¤ê°€ MySQL ì €ìž¥ì„ ì „ë‹´í•˜ì—¬ Slow SQL ë³‘ëª© í•´ê²°
  - ë©±ë“±ì„±(Idempotency) ì„¤ê³„: Kafkaì˜ ìž¬ì „ì†¡ ì •ì±…ìœ¼ë¡œ ì¸í•œ ì¤‘ë³µ ë°ì´í„° ìœ ìž… ì‹œì—ë„ DB ë¬´ê²°ì„±ì„ ìœ ì§€í•˜ë„ë¡ UNIQUE KEY ê¸°ë°˜ì˜ ë°©ì–´ë§‰ êµ¬ì¶•
  - DB ìµœì í™” (GORM Clauses): OnConflict(DoNothing) ì „ëžµì„ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ë°ì´í„° ë°œìƒ ì‹œ ë¶ˆí•„ìš”í•œ ì—ëŸ¬ ë¡œê·¸ ì²˜ë¦¬
  - ì¸í„°íŽ˜ì´ìŠ¤ ê³ ë„í™”: ë¦¬í¬ì§€í† ë¦¬ í•¨ìˆ˜ ë¦¬í„´ íƒ€ìž…ì„ (bool, error)ë¡œ ê°œì„ í•˜ì—¬ ì‹¤ì œ ì €ìž¥ ì„±ê³µ ì—¬ë¶€ë¥¼ ì›Œì»¤ê°€ ëª…í™•ížˆ ì¸ì§€í•˜ë„ë¡ êµ¬í˜„
- **ê²°ê³¼**: ê³ ë¶€í•˜ ìƒí™©ì—ì„œë„ Redisì˜ ì²˜ë¦¬ ì†ë„ì™€ DB ì €ìž¥ ì†ë„ ê°„ì˜ ê°„ê·¹ì„ Kafka ë²„í¼ë¡œ í•´ì†Œí•˜ê³ , ë°ì´í„° ì •í•©ì„± 100% ë‹¬ì„±

### ðŸŸ¤ v5.0: ë¹„ë™ê¸° ì •í•©ì„± ì™„ì„± ë° Lua ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ ìž¬ê³  ë³´í˜¸
- **ì£¼ìš” ë‚´ìš©**: ë¹„ë™ê¸° ì·¨ì†Œ íŒŒì´í”„ë¼ì¸ êµ¬ì¶• ë° ìž¬ê³  ì²˜ë¦¬ ë¡œì§ ì™„ì„±
  - Lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©í•œ ì›ìžì  ìž¬ê³  ê´€ë¦¬: ê¸°ì¡´ DECR ë°©ì‹ì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ Redis ë‚´ë¶€ì—ì„œ ìž”ì—¬ ìž¬ê³  í™•ì¸ + ì°¨ê°ì„ í•˜ë‚˜ì˜ ì›ìžì  ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•˜ëŠ” Lua Script ë„ìž…
  - ë¹„ë™ê¸° ì·¨ì†Œ í”„ë¡œì„¸ìŠ¤ (Delete-Behind): ì·¨ì†Œ ìš”ì²­ ì‹œ Redis ìž¬ê³ ë¥¼ ì¦‰ì‹œ ë³µêµ¬í•˜ê³  ëª…ë‹¨ì—ì„œ ì œê±°í•˜ì—¬ ìœ ì €ì—ê²Œ **ê°€ìš©ì„±(Availability)**ì„ ì¦‰ì‹œ ë°˜í™˜
                                        ì‹¤ì œ DB ë°ì´í„° ì‚­ì œëŠ” Kafkaë¥¼ í†µí•´ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ì˜ˆë§¤ì™€ ë™ì¼í•œ ê³ ì„±ëŠ¥ ì“°ê¸° ì•„í‚¤í…ì²˜ ì™„ì„±
  - ìž¥ì•  ë³µêµ¬ íŒŒì´í”„ë¼ì¸(DLQ) ë„ìž…: ì›Œì»¤ê°€ DB ì €ìž¥ ì‹¤íŒ¨ ì‹œ 3íšŒ ìž¬ì‹œë„ë¥¼ ìˆ˜í–‰í•˜ê³ , ìµœì¢… ì‹¤íŒ¨ ì‹œ ticket-dlq-topicìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ê²©ë¦¬í•˜ì—¬ ë°ì´í„° ìœ ì‹¤ 0% ë‹¬ì„±
- **ê²°ê³¼**: ìž¬ê³  ì •í™•ë„ í™•ë³´: ë¬´í•œ ë£¨í”„ ì˜ˆë§¤/ì·¨ì†Œ í…ŒìŠ¤íŠ¸ ì‹œì—ë„ ìž¬ê³ ê°€ í•­ìƒ 0 ~ MAXì‚¬ì´ë¥¼ ìœ ì§€

### âšª v6.0: Observability êµ¬ì¶• ë° ì‹œìŠ¤í…œ ì‹ ë¢°ì„± ê²€ì¦
- **ì£¼ìš” ë‚´ìš©**: Prometheus/Grafana ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ë„ìž… ë° ëŒ€ê·œëª¨ ë¶€í•˜ í…ŒìŠ¤íŠ¸(50,000 TPS) ìˆ˜í–‰
  - ì‹œìŠ¤í…œ ê°€ì‹œì„±(Visibility) í™•ë³´: ì„œë²„ ë° ì›Œì»¤ì— Prometheus ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë…¸ì¶œí•˜ì—¬ ìš”ì²­ ìˆ˜, DB ì €ìž¥ ì„±ê³µ ìˆ˜, ì²˜ë¦¬ ì§€ì—° ì‹œê°„ ë“±ì„ ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œë¡œ ì‹œê°í™”
  - ë¶„ì‚° ì›Œì»¤ ì‹œë®¬ë ˆì´ì…˜: ë‹¤ì¤‘ ì›Œì»¤ êµ¬ì¡°ì—ì„œ Kafka íŒŒí‹°ì…˜ë³„ ë©”ì‹œì§€ ë¶„ë°° ë° ë³‘ë ¬ ì²˜ë¦¬ íš¨ìœ¨ì„± ê²€ì¦
  - ëŒ€ê·œëª¨ íŠ¸ëž˜í”½ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸: go routineì„ í™œìš©í•œ 50,000ëª…ì˜ ë™ì‹œ ì ‘ì† ìƒí™©ì„ ìž¬í˜„í•˜ì—¬ ì‹œìŠ¤í…œì˜ í•œê³„ ì§€ì  ì¸¡ì •
- **ê²°ê³¼**
  - ë¹„ë™ê¸° ì²˜ë¦¬ ì´ì  ì‹¤ì¦: í•˜ë‹¨(ìš”ì²­) ê·¸ëž˜í”„ì˜ í­ì¦ì—ë„ ìƒë‹¨(DB ì €ìž¥) ê·¸ëž˜í”„ê°€ ì™„ë§Œí•œ ê²½ì‚¬ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì„ í™•ì¸í•˜ë©°, Kafkaì˜ ë¶€í•˜ í‰íƒ„í™”(Load Leveling) íš¨ê³¼ë¥¼ ìˆ˜ì¹˜ë¡œ ì¦ëª…

    ![ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼](./images/grafana_result_v6.jpg)
    
  - ë°ì´í„° ìœ ì‹¤ ì œë¡œ: 5ë§Œ ê±´ì˜ ëª°ìž… íŠ¸ëž˜í”½ ì†ì—ì„œë„ ìµœì¢… ìž¬ê³  ìˆ˜ëŸ‰ê³¼ DB ì €ìž¥ ìˆ˜ëŸ‰ì´ 100% ì¼ì¹˜í•˜ëŠ” ë¬´ê²°ì„± í™•ì¸
  - ì¸í”„ë¼ ì•ˆì •ì„±: ì´ˆë‹¹ ìˆ˜ë§Œ ê±´ì˜ ìš”ì²­ ìƒí™©ì—ì„œ Redisì™€ Kafkaë¥¼ ê±°ì¹˜ëŠ” ì „ì²´ íŒŒì´í”„ë¼ì¸ì˜ ì•ˆì •ì ì¸ ê°€ë™ ì‹œê°„(Uptime) í™•ë³´

- ### âš« v7.0: ë¶„ì‚° ëŒ€ê¸°ì—´(Virtual Queue) ê³ ë„í™” ë° ì‹œìŠ¤í…œ ì•ˆì •ì„± ìµœì¢… ì™„ì„±
- **ì£¼ìš” ë‚´ìš©**: ê³ ë¶€í•˜ ìƒí™©ì—ì„œ ì„œë²„ ë¦¬ì†ŒìŠ¤ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•œ ê°€ìƒ ëŒ€ê¸°ì—´ ë„ìž… ë° ìž¥ì•  ë³µêµ¬ ë¡œì§ êµ¬í˜„
  - Virtual Waiting Queue: Redis Sorted Setì„ í™œìš©í•˜ì—¬ WAITING ìœ ì €ì—ê²ŒëŠ” ì‹¤ì‹œê°„ ìˆœë²ˆ(Rank)ì„ ì œê³µí•˜ê³ , ACTIVE ìœ ì €ë§Œ ì‹¤ì œ ì˜ˆë§¤ ë¡œì§ì„ ìˆ˜í–‰í•˜ë„ë¡ Throttling êµ¬í˜„
- **ê²°ê³¼**: 
  - **íŠ¸ëž˜í”½ ì œì–´ ëŠ¥ë ¥ í™•ë³´**: ìˆ˜ë§Œ ëª…ì˜ ë™ì‹œ ì ‘ì† ìƒí™©ì—ì„œë„ ì„œë²„ê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì˜ ë¶€í•˜ë§Œ ìœ ì§€í•˜ë©° ì•ˆì •ì ìœ¼ë¡œ ê°€ë™ë¨ì„ í™•ì¸
  - **ë°ì´í„° ë¬´ê²°ì„± ë° ë‚´ê²°í•¨ì„± ì™„ì„±**: ë¹„ë™ê¸° ëŒ€ê¸°ì—´ í†µê³¼ í›„ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ì†Œìˆ˜ì˜ ì‹¤íŒ¨ ê±´ìˆ˜ê¹Œì§€ DLQë¡œ ì™„ë²½í•˜ê²Œ ê²©ë¦¬ ë° ë³µêµ¬ ê°€ëŠ¥í•œ ìƒíƒœë¡œ í”„ë¡œì íŠ¸ ì¢…ë£Œ

---
## ðŸ›  Tech Stack
- **Language**: `Go (1.21+)` - ê³ ì„±ëŠ¥ ê³ ë£¨í‹´ì„ í™œìš©í•œ ë™ì‹œì„± ì²˜ë¦¬
- **Database**: `MySQL 8.0` - GORMì„ ì´ìš©í•œ êµ¬ë§¤ ë°ì´í„° ì˜ì†í™”
- **Cache & Lock**: `Redis` - Lua Script ê¸°ë°˜ ì›ìžì  ìž¬ê³  ê´€ë¦¬ ë° ëŒ€ê¸°ì—´ êµ¬í˜„
- **Message Broker**: `Apache Kafka` - ë¹„ë™ê¸° ì“°ê¸° ìž‘ì—…ì„ í†µí•œ ì‹œìŠ¤í…œ ë¶€í•˜ ë¶„ì‚°
- **Monitoring**: `Prometheus` & `Grafana` - ì‹¤ì‹œê°„ TPS ë° ì‹œìŠ¤í…œ ì§€í‘œ ì‹œê°í™”
- **Container**: `Docker` & `Docker Compose` - ì¼ê´€ëœ ì¸í”„ë¼ í™˜ê²½ êµ¬ì¶•

## ðŸš¦ ì‹¤í–‰ ë°©ë²• (How to Run)
1. **ì¸í”„ë¼ ì»¨í…Œì´ë„ˆ ì‹¤í–‰**
   Docker Composeë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë¯¸ë“¤ì›¨ì–´(MySQL, Redis, Kafka, Zookeeper)ë¥¼ í•œêº¼ë²ˆì— ì‹¤í–‰í•©ë‹ˆë‹¤.
   ```bash
   docker-compose up -d
   
2. **MySQL í…Œì´ë¸” ìƒì„± ë° ì œì•½ ì¡°ê±´ ì„¤ì •**

   ì¤‘ë³µ ì˜ˆë§¤ ë°©ì§€(ë©±ë“±ì„±)ë¥¼ ìœ„í•´ UNIQUE KEYê°€ í¬í•¨ëœ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
   ```bash
   CREATE TABLE purchases (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    ticket_name VARCHAR(255) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_ticket (user_id, ticket_name)
   );
   
4. **Kafka Consumer ì›Œì»¤ ì‹¤í–‰**
   Kafka ì´ë²¤íŠ¸ë¥¼ ê°ì‹œí•˜ë©° DBì— ì €ìž¥í•˜ëŠ” ì›Œì»¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. (ë‹¤ì¤‘ í„°ë¯¸ë„ ì‹¤í–‰ ê¶Œìž¥)
   ```bash
   go run cmd/worker/main.go
5. **API ì„œë²„ ë° ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰**
   ì‹¤ì œ ì˜ˆë§¤ ìš”ì²­ì„ ìƒì„±í•˜ì—¬ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
   ```bash
   go run main.go


sequenceDiagram
    participant User
    participant API as Go API Server
    participant Redis as Redis (Queue/Stock)
    participant Kafka
    participant Worker as DB Worker
    participant MySQL

    User->>API: ì˜ˆë§¤ ìš”ì²­ (user_id)
    API->>Redis: ëŒ€ê¸°ì—´ ì§„ìž… ë° ìˆœë²ˆ í™•ì¸
    Note over API, Redis: Lua Script (Atomic Stock)
    API-->>User: 202 Accepted (ëŒ€ê¸° ìˆœë²ˆ ë°˜í™˜)
    
    API->>Kafka: ì˜ˆë§¤ ì„±ê³µ ì´ë²¤íŠ¸ ë°œí–‰
    Kafka->>Worker: ì´ë²¤íŠ¸ ì»¨ìŠ˜
    Worker->>MySQL: êµ¬ë§¤ ë‚´ì—­ ì €ìž¥ (Unique Key ë³´ìž¥)
    Note right of MySQL: ë©±ë“±ì„± ìœ ì§€
